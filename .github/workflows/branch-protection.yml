# .github/workflows/branch-protection.yml
name: üõ°Ô∏è Branch Protection

on:
  pull_request:
    branches: [main]

jobs:
  validate-source-branch:
    name: Validate PR Source Branch
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Branch Protection Rules
        run: |
          echo "üîç Validating PR source branch..."
          echo "üìç Source: ${{ github.head_ref }}"
          echo "üéØ Target: ${{ github.base_ref }}"
          echo ""
          
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          # Only enforce rules for PRs targeting main
          if [[ "$TARGET_BRANCH" != "main" ]]; then
            echo "‚úÖ Target is not main branch ($TARGET_BRANCH) - no restrictions apply"
            echo "üéâ This PR can proceed normally"
            exit 0
          fi
          
          # Only enforce rules for PRs targeting main
          if [[ "$TARGET_BRANCH" != "main" ]]; then
            echo "‚úÖ Target is not main branch ($TARGET_BRANCH) - no restrictions apply"
            echo "üéâ This PR can proceed normally"
            exit 0
          fi
          
          echo "üõ°Ô∏è Checking main branch protection rules..."
          
          # Define allowed patterns
          if [[ "$SOURCE_BRANCH" == "develop" ]] || 
             [[ "$SOURCE_BRANCH" =~ ^hotfix/.+ ]] || 
             [[ "$SOURCE_BRANCH" =~ ^release/.+ ]]; then
            echo "‚úÖ SUCCESS: Branch '$SOURCE_BRANCH' is authorized to merge to main"
            echo "üéâ This PR follows our branching policy and can proceed"
          else
            echo "üö´ POLICY VIOLATION: Branch '$SOURCE_BRANCH' cannot merge to main"
            echo ""
            echo "üìã ALLOWED SOURCE BRANCHES:"
            echo "   ‚Ä¢ develop           (regular releases)"
            echo "   ‚Ä¢ hotfix/*          (critical fixes)"  
            echo "   ‚Ä¢ release/*         (release preparation)"
            echo ""
            echo "üîÑ CORRECT WORKFLOW:"
            echo "   $SOURCE_BRANCH ‚Üí develop ‚Üí main"
            echo ""
            echo "üí° NEXT STEPS:"
            echo "   1. Close this PR"
            echo "   2. Create PR: $SOURCE_BRANCH ‚Üí develop"
            echo "   3. After merge to develop, create: develop ‚Üí main"
            echo ""
            echo "This check failed to enforce our branching policy."
            exit 1
          fi
