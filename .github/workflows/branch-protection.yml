name: ğŸ›¡ï¸ Branch Protection

on:
  pull_request:
    branches: 
      - main
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-source-branch:
    name: Validate PR Source Branch
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Branch Protection Rules
        id: branch-check
        run: |
          echo "ğŸ” Validating PR details..."
          echo "ğŸ“ Source branch: ${{ github.head_ref }}"
          echo "ğŸ¯ Target branch: ${{ github.base_ref }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ”— PR: ${{ github.event.pull_request.html_url }}"
          echo ""
          
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          # Only check if target is main branch
          if [[ "$TARGET_BRANCH" != "main" ]]; then
            echo "âœ… Target is not main branch - no restrictions apply"
            exit 0
          fi
          
          echo "ğŸ›¡ï¸  Checking main branch protection rules..."
          
          # Define allowed source branch patterns
          ALLOWED_PATTERNS=(
            "^develop$"
            "^hotfix/.+"
            "^release/.+"
          )
          
          # Check if source branch matches any allowed pattern
          BRANCH_ALLOWED=false
          
          for pattern in "${ALLOWED_PATTERNS[@]}"; do
            if [[ "$SOURCE_BRANCH" =~ $pattern ]]; then
              BRANCH_ALLOWED=true
              echo "âœ… Branch '$SOURCE_BRANCH' matches allowed pattern: $pattern"
              break
            fi
          done
          
          if [[ "$BRANCH_ALLOWED" == "true" ]]; then
            echo ""
            echo "ğŸ‰ SUCCESS: PR is authorized!"
            echo "âœ¨ Branch '$SOURCE_BRANCH' can create PRs to main"
            
            # Set output for success message
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Authorized branch: $SOURCE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "ğŸš« POLICY VIOLATION DETECTED!"
            echo "âŒ Branch '$SOURCE_BRANCH' is NOT authorized to create PRs to main"
            echo ""
            echo "ğŸ“‹ ALLOWED SOURCE BRANCHES:"
            echo "   â€¢ develop           (regular releases)"
            echo "   â€¢ hotfix/*          (critical production fixes)"
            echo "   â€¢ release/*         (release preparation)"
            echo ""
            echo "ğŸ”„ CORRECT WORKFLOW:"
            echo "   feature/* â†’ develop â†’ main"
            echo "   bugfix/*  â†’ develop â†’ main"
            echo "   hotfix/*  â†’ main (emergency only)"
            echo ""
            echo "ğŸ’¡ NEXT STEPS:"
            echo "   1. Close this PR"
            echo "   2. Create PR: $SOURCE_BRANCH â†’ develop"
            echo "   3. After merge, create: develop â†’ main"
            echo ""
            
            # Set output for failure
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Unauthorized branch: $SOURCE_BRANCH" >> $GITHUB_OUTPUT
            
            exit 1
          fi

      - name: Add Success Comment
        if: steps.branch-check.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… Branch Protection Check Passed
            
            **Source Branch:** \`${{ github.head_ref }}\`  
            **Target Branch:** \`${{ github.base_ref }}\`  
            **Status:** ğŸ‰ **AUTHORIZED**
            
            This PR follows our branching policy and can proceed with the review process.
            
            ---
            *Automated check by Branch Protection workflow*`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Branch Protection Check')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Add Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸš« Branch Protection Policy Violation
            
            **Source Branch:** \`${{ github.head_ref }}\`  
            **Target Branch:** \`${{ github.base_ref }}\`  
            **Status:** âŒ **UNAUTHORIZED**
            
            ### ğŸ“‹ Allowed Source Branches for \`main\`:
            - \`develop\` - Regular releases and feature integration
            - \`hotfix/*\` - Critical production fixes only  
            - \`release/*\` - Release preparation and versioning
            
            ### ğŸ”„ Correct Workflow:
            \`\`\`
            feature/your-feature â†’ develop â†’ main
            bugfix/your-fix     â†’ develop â†’ main  
            hotfix/urgent-fix   â†’ main (emergency only)
            \`\`\`
            
            ### ğŸ’¡ How to Fix This:
            1. **Close this PR** âŒ
            2. **Create a new PR:** \`${{ github.head_ref }} â†’ develop\` âœ…
            3. **After merge to develop:** Create \`develop â†’ main\` PR for release ğŸš€
            
            ### â“ Questions?
            - Check our [Contributing Guidelines](../../blob/main/CONTRIBUTING.md)
            - Ask in team chat for clarification
            
            ---
            *This policy ensures code quality and proper release management.*  
            *Automated check by Branch Protection workflow*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Optional: Also run basic code quality checks
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run linting (Backend)
        run: pnpm --filter backend lint
        continue-on-error: false
        
      - name: Run tests (Backend)  
        run: pnpm --filter backend test
        continue-on-error: false
        
      # Add frontend checks when you have a frontend
      # - name: Run linting (Frontend)
      #   run: pnpm --filter frontend lint
      #   continue-on-error: false
      
      - name: Check build (Backend)
        run: pnpm --filter backend build
        continue-on-error: false
